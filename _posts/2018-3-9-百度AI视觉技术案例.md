---

layout: post
categories: [AI]
tags: [AI, Machine Learning]

---

利用[百度AI平台](https://ai.baidu.com)实现简单的视觉技术。

在平台“控制台”中创建所需应用，然后分别记录`appID`、`Api_Key`和`Secret_Key`，用于程序中的访问权限获取（具体创建方法不在此赘述）。

# 1， 人脸识别

### 1.1 人脸检测

#### 接口能力

- 人脸检测：检测图片中的人脸并标记出位置信息;
- 人脸关键点：展示人脸的核心关键点信息，及72个关键点信息。
- 人脸属性值：展示人脸属性信息，如年龄、性别等。
- 人脸质量信息：返回人脸各部分的遮挡、光照、模糊、完整度、置信度等信息。


#### 业务应用

典型应用场景：如人脸属性分析，基于人脸关键点的加工分析，人脸营销活动等。

#### 质量检测

如果需要判断一张图片中的人脸，是否符合后续识别或者对比的条件，可以使用此接口，在请求时在`face_fields`参数中请求`qualities`。基于返回结果`qualities`中，以下字段及对应阈值，进行质量检测的判断，以保证人脸质量符合后续业务操作要求。

#### 简单例子

```Python
from aip import AipFace

if __name__ == '__main__':
    """ 设定 APPID AK SK """
    APP_ID = '10895978'
    API_KEY = 'eiHvcrvkVNNYCpszd74bu7XD'
    SECRET_KEY = 'tq258FE4Qop5z1XUmndN76bXAbHSKo4i'

    aipFace = AipFace(APP_ID, API_KEY, SECRET_KEY)

    # 读取图片
    filePath = "./img/db2.jpg"

    def get_file_content(filePath):
        with open(filePath, 'rb') as fp:
            return fp.read()

    # 定义参数变量
    options = {
        'max_face_num': 1,
        'face_fields': "age,beauty,expression,faceshape",
    }

    # 调用人脸属性检测接口
    result = aipFace.detect(get_file_content(filePath), options)

    print(result)
```

输出结果：

```json
{
    "result_num": 1, 
    "result": [
        {
            "location": {
                "left": 987, 
                "top": 365, 
                "width": 468, 
                "height": 442
            }, 
            "face_probability": 1, 
            "rotation_angle": 9, 
            "yaw": -4.873851776123, 
            "pitch": 11.62779045105, 
            "roll": 10.357309341431, 
            "age": 44, 
            "beauty": 72.05835723877, 
            "expression": 1, 
            "expression_probablity": 0.98539078235626, 
            "faceshape": [
                {
                    "type": "square", 
                    "probability": 0.29037597775459
                }, 
                {
                    "type": "triangle", 
                    "probability": 0.0018628753023222
                }, 
                {
                    "type": "oval", 
                    "probability": 0.66113710403442
                }, 
                {
                    "type": "heart", 
                    "probability": 0.0021002173889428
                }, 
                {
                    "type": "round", 
                    "probability": 0.044523812830448
                }
            ]
        }
    ], 
    "log_id": 3668917883030910
}
```

#### 返回值含义

参数|	类型|	必选|	说明
---|---|---|---
log_id|	uint64|	是|	日志id
result_num|	uint32|	是|	人脸数目
result|	object[]|	是|	人脸属性对象的集合
+age|	double|	否|	年龄。face_fields包含age时返回
+beauty|	double|	否|	美丑打分，范围0-100，越大表示越美。face_fields包含beauty时返回
+location|	object|	是|	人脸在图片中的位置
++left|	uint32|	是|	人脸区域离左边界的距离
++top|	uint32|	是|	人脸区域离上边界的距离
++width|	uint32|	是|	人脸区域的宽度
++height|	uint32|	是|	人脸区域的高度
+face_probability|	double|	是|	人脸置信度，范围0-1
+rotation_angle|	int32|	是|	人脸框相对于竖直方向的顺时针旋转角，[-180,180]
+yaw|	double|	是|	三维旋转之左右旋转角[-90(左), 90(右)]
+pitch|	double|	是|	三维旋转之俯仰角度[-90(上), 90(下)]
+roll|	double|	是|	平面内旋转角[-180(逆时针), 180(顺时针)]
+expression|	uint32|	否|	表情，0，不笑；1，微笑；2，大笑。face_fields包含expression时返回
+expression_probability|	double|	否|	表情置信度，范围0~1。face_fields包含expression时返回
+faceshape|	object[]|	否|	脸型置信度。face_fields包含faceshape时返回
++type|	string|	是|	脸型：square/triangle/oval/heart/round
++probability|	double|	是|	置信度：0~1
+gender|	string|	否|	male、female。face_fields包含gender时返回
+gender_probability|	double|	否|	性别置信度，范围[0~1]，face_fields包含gender时返回
+glasses|	uint32|	否|	是否带眼镜，0-无眼镜，1-普通眼镜，2-墨镜。face_fields包含glasses时返回
+glasses_probability|	double|	否|	眼镜置信度，范围[0~1]，face_fields包含glasses时返回
+landmark|	object[]|	否|	4个关键点位置，左眼中心、右眼中心、鼻尖、嘴中心。face_fields包含landmark时返回
++x|	uint32|	否|	x坐标
++y|	uint32|	否|	y坐标
+landmark72|	object[]|	否|	72个特征点位置，face_fields包含landmark时返回
++x|	uint32|	否|	x坐标
++y|	uint32|	否|	y坐标
+race|	string|	否|	yellow、white、black、arabs。face_fields包含race时返回
+race_probability|	double|	否|	人种置信度，范围[0~1]，face_fields包含race时返回
+qualities|	object|	否|	人脸质量信息。face_fields包含qualities时返回
++occlusion|	object|	是|	人脸各部分遮挡的概率，范围[0~1]，0表示完整，1表示不完整
+++left_eye|	double|	是|	左眼遮挡比例
+++right_eye|	double|	是|	右眼遮挡比例
+++nose|	double|	是|	鼻子遮挡比例
+++mouth|	double|	是|	嘴巴遮挡比例
+++left_cheek|	double|	是|	左脸颊遮挡比例
+++right_cheek|	double|	是|	右脸颊遮挡比例
+++chin|	double|	是|	下巴遮挡比例
++blur|	double|	是|	人脸模糊程度，范围[0~1]，0表示清晰，1表示模糊
++illumination|	-|	是|	取值范围在[0~255],表示脸部区域的光照程度
++completeness|	-|	是|	人脸完整度，0或1, 0为人脸溢出图像边界，1为人脸都在图像边界内
++type|	object|	是|	真实人脸/卡通人脸置信度
+++human|	-|	是|	真实人脸置信度，[0~1]，大于0.5可以判断为人脸
+++cartoon|	-|	是|	卡通人脸置信度，[0~1]

---

### 1.2 人脸对比

#### 接口能力

- 两张人脸图片相似度对比：比对两张图片中人脸的相似度，并返回相似度分值；
- 多种图片类型：支持生活照、证件照、身份证芯片照、带网纹照四种类型的人脸对比；
- 活体检测：基于图片中的破绽分析，判断其中的人脸是否为二次翻拍（举例：如用户A用手机拍摄了一张包含人脸的图片一，用户B翻拍了图片一得到了图片二，并用图片二伪造成用户A去进行识别操作，这种情况普遍发生在金融开户、实名认证等环节。）；
- 质量检测：返回模糊、光照等质量检测信息，用于辅助判断图片是否符合识别要求；

#### 业务应用

用于比对多张图片中的人脸相似度并返回两两比对的得分，可用于判断两张脸是否是同一人的可能性大小。

典型应用场景：如人证合一验证，用户认证等，可与您现有的人脸库进行比对验证。

#### 简单例子

```Python
from aip import AipFace

if __name__ == "__main__":
    APP_ID = '10895978'
    API_KEY = 'eiHvcrvkVNNYCpszd74bu7XD'
    SECRET_KEY = 'tq258FE4Qop5z1XUmndN76bXAbHSKo4i'
    aipFace= AipFace(APP_ID, API_KEY, SECRET_KEY)

    def get_file_content(filePath):
        with open(filePath, 'rb') as fp:
            return fp.read()

    images = [
        get_file_content('./img/db1.jpg'),
        get_file_content('./img/db2.jpg')
    ]

    result = aipFace.match(images)

    print(result)

    # """ 如果有可选参数 """
    # options = {}
    # options["ext_fields"] = "qualities"
    # options["image_liveness"] = ",faceliveness"
    # options["types"] = "7,13"
    #
    # result_opt = aipFace.match(images, options)
    #
    # print(result_opt)
```

输出结果

```json
{
    "result": [
        {
            "index_i": "0", 
            "index_j": "1", 
            "score": 70.682899475098
        }
    ], 
    "result_num": 1, 
    "log_id": 3136201939031014
}
```

#### 返回值含义

字段|	必选|	类型|	说明
---|---|---|---
log_id|	是|	uint64|	请求唯一标识码，随机数
result_num|	是|	uint32|	返回结果数目，即：result数组中元素个数
result|	是|	array(object)|	结果数据，index和请求图片index对应。数组元素为每张图片的匹配得分数组，top n。得分范围[0,100.0]
+index_i|	是|	uint32|	比对图片1的index
+index_j|	是|	uint32|	比对图片2的index
+score|	是|	double|	比对得分，推荐80分作为阈值，80分以上可以判断为同一人，此分值对应万分之一误识率
ext_info|	否|	array（dict）|	对应参数中的ext_fields
+qualities|	否|	string|	质量相关的信息，无特殊需求可以不使用
+faceliveness|	否|	string|	活体检测分数，单帧活体检测参考阈值0.393241，超过此分值以上则可认为是活体。注意：活体检测接口主要用于判断是否为二次翻拍，需要限制用户为当场拍照获取图片；推荐配合客户端SDK有动作校验活体使用


---
 
### 1.3 人脸识别

#### 业务能力

- 1：N人脸识别：也称为1：N识别，在指定人脸集合中，找到最相似的人脸；
- 1：N人脸认证：基于uid维度的1：N识别，由于uid已经锁定固定数量的人脸，所以检索范围更聚焦；
- M：N多人脸识别：也称为M：N识别，待识别图片中含有多个人脸时，在指定人脸集合中，找到这多个人脸分别最相似的人脸；

1：N人脸识别与1：N人脸认证的差别在于：人脸识别是在指定人脸集合中进行直接地人脸检索操作，而人脸认证是基于uid，先调取这个uid对应的人脸，再在这个uid对应的人脸集合中进行检索（因为每个uid通常对应的只有一张人脸，所以通常也就变为了1：1对比）；实际应用中，人脸认证需要用户或系统先输入id，这增加了验证安全度，但也增加了复杂度，具体使用哪个接口需要视您的业务场景判断。

M：N识别的原理，相当于在多个人脸的图片中，先分别找出所有人脸，然后分别在待查找的人脸集合中，分别做1：N识别，最后将识别结果汇总在一起进行返回。

用于计算指定组内用户，与上传图像中人脸的相似度。识别前提为您已经创建了一个人脸库。

典型应用场景：如人脸闸机，考勤签到，安防监控等。

说明：人脸识别返回值不直接判断是否是同一人，只返回用户信息及相似度分值。

说明：推荐可判断为同一人的相似度分值为80，您也可以根据业务需求选择更合适的阈值。

#### 简单例子

```Python
from aip import AipFace

if __name__ == "__main__":
    groupId = "davidbeckham"

    APP_ID = '10895978'
    API_KEY = 'eiHvcrvkVNNYCpszd74bu7XD'
    SECRET_KEY = 'tq258FE4Qop5z1XUmndN76bXAbHSKo4i'
    aipFace = AipFace(APP_ID, API_KEY, SECRET_KEY)

    """ 读取图片 """
    def get_file_content(filePath):
        with open(filePath, 'rb') as fp:
            return fp.read()

    image = get_file_content('./img/db3.jpg')

    """ 调用人脸识别 """
    result = aipFace.identifyUser(groupId, image);
    print(result)

    # """ 如果有可选参数 """
    # options = {}
    # options["ext_fields"] = "faceliveness"
    # options["user_top_num"] = 3
    #
    # """ 带参数调用人脸识别 """
    # aipFace.identifyUser(groupId, image, options)
```

返回结果：

```json
{
    "result": [
        {
            "uid": "DavidBeckham", 
            "scores": [
                72.19522857666
            ], 
            "group_id": "davidbeckham", 
            "user_info": ""
        }
    ], 
    "result_num": 1, 
    "log_id": 3794890709031016
}
```

#### 返回参数

字段|	必选|	类型|	说明
---|---|---|---
log_id|	是|	uint64|	请求唯一标识码，随机数
result_num|	是|	uint32|	返回结果数目，即：result数组中元素个数
result|	是|	array(double)|	结果数组，数组元素为匹配得分，top n。 得分范围[0,100.0]。超过80分可认为认证成功
ext_info|	否|	array|	对应参数中的ext_fields
+faceliveness|	否|	string|	活体检测分数，单帧活体检测参考阈值0.393241，超过此分值以上则可认为是活体。活体检测接口主要用于判断是否为二次翻拍，需要限制用户为当场拍照获取图片；推荐配合客户端SDK有动作校验活体使用

关于活体检测faceliveness的判断阈值选择，可参考以下数值信息：


拒绝率（TRR）|	误拒率（FRR）|	通过率（TAR）|	阈值（Threshold）
---|---|---|---
0.90325733|	0.1%|	99.9%|	0.022403
0.96254072|	0.5%|	99.5%|	0.393241（推荐）
0.97557003|	1%|	99%|	0.649192
0.98990228|	2%|	98%|	0.933801
0.99446254|	3%|	97%|	0.973637
0.99641694|	4%|	96%|	0.988479
0.99739414|	5%|	95%|	0.994058
